pipeline {
    agent any

    environment {
        SONARQUBE_ENV  = 'SonarQube'                // Nom du serveur SonarQube d√©clar√© dans Jenkins
        SCANNER_NAME   = 'SonarQube Scanner'        // Nom du scanner SonarQube install√© dans Jenkins
        PROJECT_KEY    = 'alpinehelloworld'         // projectKey SonarQube
        SONARQUBE_URL  = 'http://sonarqube:9000'    // URL du service SonarQube
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo 'üîÑ R√©cup√©ration du code source...'
                checkout scm
            }
        }

        stage('Install Python Dependencies') {
            steps {
                echo 'üì¶ Installation des d√©pendances Python...'
                sh '''
                    if [ -f requirements.txt ]; then
                        python3 -m venv venv
                        bash -c "source venv/bin/activate && pip install -r requirements.txt"
                    else
                        echo "‚ö†Ô∏è Aucun fichier requirements.txt trouv√©, √©tape ignor√©e."
                    fi
                '''
            }
        }

        stage('Analyse SonarQube') {
            steps {
                echo 'üîç Lancement de l‚Äôanalyse SonarQube...'
                script {
                    def scannerHome = tool "${SCANNER_NAME}"

                    withSonarQubeEnv("${SONARQUBE_ENV}") {

                        withCredentials([string(credentialsId: 'alpinehelloworld', variable: 'SONAR_TOKEN')]) {

                            sh """
${scannerHome}/bin/sonar-scanner \
  -Dsonar.projectKey=${PROJECT_KEY} \
  -Dsonar.sources=. \
  -Dsonar.inclusions=Scan_docker.py \
  -Dsonar.exclusions=venv/**,**/__pycache__/**,**/*.pyc \
  -Dsonar.login=${SONAR_TOKEN} \
  -Dsonar.host.url=${SONARQUBE_URL}
"""
                        }
                    }
                }
            }
        }

        stage('Build Python Project') {
            steps {
                echo 'üîß Compilation √©ventuelle (setup.py)...'
                sh '''
                    if [ -f setup.py ]; then
                        python setup.py install
                    else
                        echo "Pas de setup.py, √©tape ignor√©e."
                    fi
                '''
            }
        }
    }

    post {
        success {
            echo '‚úÖ Pipeline termin√©e avec succ√®s.'
        }
        failure {
            echo '‚ùå √âchec de la pipeline.'
        }
    }
}
